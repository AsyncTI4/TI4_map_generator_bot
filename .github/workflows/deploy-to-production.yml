on:
  push:
    branches: [ "master" ]
name: BuildAndDeploy
jobs:
  saveGamesBeforeDeploy:
    uses: ./.github/workflows/force-backup-of-savefiles.yml
    secrets: inherit
  build:
    concurrency:
      group: "Start Bot"
    needs: saveGamesBeforeDeploy
    name: Build, Test, & Deploy Bot
    runs-on: ubuntu-latest
    steps:
      - name: Execute remote ssh commands
        uses: appleboy/ssh-action@master
        env:
            AWS_KEY: ${{ secrets.IMG_AWS_KEY }}
            AWS_SECRET: ${{ secrets.IMG_AWS_SECRET }}
            DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
            DISCORD_BOT_USERID: ${{ secrets.DISCORD_BOT_USERID }}
            DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
            REPO_DISPATCH_TOKEN: ${{ secrets.REPOSITORY_DISPATCH_TOKEN }}
            TI4_ULTIMATE_STATISTICS_API_KEY: ${{ secrets.TI4_ULTIMATE_STATISTICS_API_KEY }}
            MANAGEMENT_ENDPOINTS_ACTUATOR_API_KEY: ${{ secrets.MANAGEMENT_ENDPOINTS_ACTUATOR_API_KEY }}
        with:
            host: ${{ secrets.HOSTINGER_SSH_HOST }}
            username: ${{ secrets.HOSTINGER_SSH_USER }}
            password: ${{ secrets.HOSTINGER_SSH_PASSWORD }}
            port: ${{ secrets.HOSTINGER_SSH_PORT }}
            envs: AWS_KEY, AWS_SECRET, DISCORD_BOT_TOKEN, DISCORD_BOT_USERID, REPO_DISPATCH_TOKEN, TI4_ULTIMATE_STATISTICS_API_KEY, MANAGEMENT_ENDPOINTS_ACTUATOR_API_KEY, DISCORD_WEBHOOK_URL
            script: |
              set -eu
              
              echo "Pulling changes from GitHub..."
              cd ${{ vars.HOST_TI4_REPO_DIR }}
              git pull --ff-only
              
              echo "Building docker image..."
              docker version
              docker build -t tibot .
              
              echo "Restarting TIBot... giving 600 seconds to shutdown"
              docker stop $(docker ps -q) --time 600
              
              echo "Starting Container..."
              docker run -v ${{ vars.HOST_TI4_SAVES_DIR }}:/opt/STORAGE -p 8081:8081 -d --restart unless-stopped -m 7g -e TI4_ULTIMATE_STATISTICS_API_KEY=$TI4_ULTIMATE_STATISTICS_API_KEY -e MANAGEMENT_ENDPOINTS_ACTUATOR_API_KEY=$MANAGEMENT_ENDPOINTS_ACTUATOR_API_KEY -e REPO_DISPATCH_TOKEN=$REPO_DISPATCH_TOKEN -e AWS_ACCESS_KEY_ID=$AWS_KEY -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET tibot $DISCORD_BOT_TOKEN $DISCORD_BOT_USERID $GUILDID_LIST
              echo "Cleaning up docker stuff..."
              
              docker rm $(docker ps --filter status=exited -q) || true
              docker rmi -f $(docker images --filter "dangling=true" -q) || true
              docker builder prune --force
              
              echo "DONE!"
  saveGamesAfterDeploy:
    needs: [build, saveGamesBeforeDeploy]
    uses: ./.github/workflows/force-backup-of-savefiles.yml
    secrets: inherit